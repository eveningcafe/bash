- name: use image_address from local registry
  set_fact:
    image_address: "{{docker_reg_host}}:{{docker_reg_port}}/{{ ceph_docker_image }}:{{ ceph_docker_image_tag }}"
  when: docker_use_local_registry

- name: use image_address from extenal registry
  set_fact:
    image_address: "{{ ceph_docker_image }}:{{ ceph_docker_image_tag }}"
  when: not docker_use_local_registry
  
- name: run docker with KV store
  docker_container:
    name: "{{ mgr_name }}"
    state: started
    image: "{{ image_address }}"
    volumes:
      - /var/lib/ceph/:/var/lib/ceph/
      - /etc/localtime:/etc/localtime
      - /var/log/ceph:/var/log/ceph
    env:
      CEPH_PUBLIC_NETWORK: "{{ ceph_public_network }}"
      KV_TYPE: "{{ kv_type }}"
      KV_IP: "{{ kv_endpoint }}"
      KV_PORT: "{{kv_port}}"
    network_mode: host
    command: mgr
    restart_policy: unless-stopped

- name: update permission log dir
  command: "docker exec {{mgr_name}} chown -R ceph:ceph /var/log/ceph"
  ignore_errors: yes

- name: sleep 30s
  pause:
    seconds: 30

# - name: restart docker
#   docker_container:
#     name: "{{ mgr_name }}"
#     state: started
#     restart: yes

- name: restart docker
  command: "docker restart {{mgr_name}}"
  ignore_errors: yes
