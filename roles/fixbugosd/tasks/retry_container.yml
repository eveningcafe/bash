- name: Set docker_registry_address
  set_fact:
    image_address: "{{docker_reg_host}}:{{docker_reg_port}}/{{ ceph_docker_image }}:{{ ceph_docker_image_tag }}"
  when: docker_use_local_registry and clean_old_ceph
- name: Set docker_registry_address
  set_fact:
    image_address: "{{ ceph_docker_image }}:{{ ceph_docker_image_tag }}"
  when: not docker_use_local_registry and clean_old_ceph
- name: create OSD
  when: (
         primarydisk is defined
         and waldisk == "no_wal"
         and dbdisk == "no_db"
        )
  docker_container:
    name: "{{ newcontainer }}"
    state: started
    image: "{{ image_address }}"
    volumes:
      - /dev/:/dev/
      - /var/log/ceph:/var/log/ceph
    env:
      OSD_DEVICE: "{{ primarydisk }}"
      KV_TYPE: etcd
      KV_IP: "{{ vip.etcd.ip }}"
      KV_PORT: 2379
      OSD_TYPE: disk
      OSD_BLUESTORE: 1
    pid_mode: host
    privileged: yes
    network_mode: host
    command: osd
    restart_policy: unless-stopped
- name: create OSD sperate wal db
  when: (
         primarydisk is defined
         and waldisk != "no_wal"
         and dbdisk != "no_db"
        )
  docker_container:
    name: "{{newcontainer}}"
    state: started
    image: "{{ image_address }}"
    volumes:
      - /dev/:/dev/
      - /var/log/ceph:/var/log/ceph
    env:
      OSD_DEVICE: "{{ primarydisk }}"
      KV_TYPE: etcd
      KV_IP: "{{ vip.etcd.ip }}"
      KV_PORT: 2379
      OSD_TYPE: disk
      OSD_BLUESTORE_BLOCK_WAL: "{{ waldisk }}"
      OSD_BLUESTORE_BLOCK_DB: "{{ dbdisk }}"
      OSD_BLUESTORE: 1
    pid_mode: host
    privileged: yes   
    network_mode: host
    command: osd   
    restart_policy: unless-stopped
  