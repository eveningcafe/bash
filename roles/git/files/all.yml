---

ops_dk_repo: https://gitlab.visc.com/thaiph5/ops_container_deployment.git
ops_dk_files_path: /usr/src/openstack-dockerfiles/
ops_dk_repo_dir: ops_container_deployment
ops_dk_repo_branch: bash/pike 
time_zone: Asia/Ho_Chi_Minh
openstack_release: pike 
openstack_branch: "stable/{{ openstack_release }}"
server_delay: 10
server_time_out: 300 
ntp_server: 192.168.181.50

proxy_addr:
proxy: 
  http_proxy: "{{ proxy_addr }}"
  https_proxy: "{{ proxy_addr }}"

services_controller: os-controller

vip:
  haproxy:
    ip: 192.168.2.206
    router_id: 206
    auth:
      auth_type: PASS
      auth_pass: KEEPALIVED_HAPROXY_AUTHPASS
  gnocchi_indexer:
    ip: 192.168.2.220
    router_id: 220
    auth:
      auth_type: PASS
      auth_pass: KEEPALIVED_GNOCCHI_INDEXER_AUTHPASS 
  postgres:
    ip: 192.168.2.207
    router_id: 207
    auth:
      auth_type: PASS
      auth_pass: KEEPALIVED_POSTGRES_AUTHPASS
  mysql:
    ip: 192.168.2.208
    router_id: 208
    auth:
      auth_type: PASS
      auth_pass: KEEPALIVED_MYSQL_AUTHPASS
  etcd:
    ip: 192.168.2.209
    router_id: 209
    auth:
      auth_type: PASS
      auth_pass: KEEPALIVED_ETCD_AUTHPASS

local_repo_ip: 10.10.0.145
local_installation: 1

#docker_version: 17.12.0~ce-0~ubuntu
docker_version: 18.03.1~ce-0~ubuntu
docker_host_port: 4000
docker_reg_port: 4000
docker_reg_host: docker-registry
docker_reg_ip: "{{ local_repo_ip }}"

docker_images_tag: "{{ openstack_release }}" 
docker_shared_conf_dir: /usr/share/docker

management_net: 10.10.0.0/24
management_netaddr: "{{ management_net | net_parser | first }}"
management_netmask: "{{ management_net | net_parser | last }}"

controlplane_mgmt_ip: "{{ vip.haproxy.ip }}"

influxdb_host: "{{ groups['influxdb'] | map('extract', hostvars, ['ansible_ssh_host']) | first }}"
influxdb_pass: INFLUXDB_PASS 

logstash_host: "{{ groups['logstash'] | map('extract', hostvars, ['ansible_ssh_host']) | first }}"
logstash_port: 5044

# services password
rabbit_user: openstack
rabbit_passwd: RABBIT_PASS 
rabbit_port: 5672

horizon_dbpass: DASHBOARD_DB_PASSWD

keystone_pass: AD_PASSWD
keystone_dbpass: ID_DB_PASSWD

glance_dbpass: IMG_DB_PASSWD 
glance_pass: IMG_SRV_PASSWD 

nova_dbpass: CP_DB_PASSWD 
nova_pass: CP_SRV_PASSWD
placement_pass: PL_PASSWD

neutron_dbpass: NW_DB_PASSWD
neutron_pass: NW_SRV_PASSWD

cinder_dbpass: BLK_DB_PASSWD
cinder_pass: BLK_SRV_PASSWD

metadata_secret: META_PASSWD
memcached_pass: MEMCACHED_PASS
memcached_port: 11211

masakari_dbpass: CPU_HA_DB_PASSWD
masakari_pass: CPU_HA_PASSWD

heat_dbpass: OCH_DB_PASSWD 
heat_pass: OCH_PASSWD
heat_domain_admin_pass: OCH_DOMAIN_PASSWD 

ceilometer_dbpass: MON_AGT_DB_PASSWD
ceilometer_pass: MON_AGT_PASSWD

gnocchi_dbpass: METRIC_DB_PASSWD
gnocchi_pass: METRIC_PASSWD

aodh_dbpass: ALARM_DB_PASSWD
aodh_pass: ALARM_PASSWD

octavia_dbpass: LB_DB_PASSWD 
octavia_pass: LB_PASSWD

no_proxy_env:
  http_proxy: ''
  https_proxy: ''

general_env:
  MY_IP: "{{ ansible_ssh_host }}" 
  TUNNEL_IP: "{{ ansible_ssh_host }}" 
  REGISTRY_HOST: "{{ services_controller }}" 
  MEMCACHED_SERVER: "{{ ansible_ssh_host }}" 
  CELL_NAME: cell1
  DB_HOST: "{{ services_controller }}"
  CONTROLLER_HOST: "{{ services_controller }}"
  REGION_NAME: North_VN
  TRANSPORT_URL: "rabbit://{% for controller in groups['controller'] %}{{ rabbit_user }}:{{ rabbit_passwd }}@{{ controller }}:{{ rabbit_port }}{% if not loop.last %},{% endif %}{% endfor %}"
  RABBIT_HOSTS: "{% for controller in groups['controller'] %}{{ controller }}:{{ rabbit_port }}{% if not loop.last %},{% endif %}{% endfor %}"
  MEMCACHED_SERVERS: "{% for controller in groups['controller'] %}{{ controller }}:{{ memcached_port }}{% if not loop.last %},{% endif %}{% endfor %}"
  MEMCACHE_SECRET_KEY: "{{ memcached_pass }}"
  SHARED_CONF_DIR: "{{ docker_shared_conf_dir }}"
  RECHECK_INTERVAL: "1m"

ops_client_env:
  OS_PROJECT_DOMAIN_NAME: Default
  OS_PROJECT_DOMAIN_ID: default
  OS_USER_DOMAIN_NAME: Default
  OS_USER_DOMAIN_ID: default
  OS_PROJECT_NAME: admin
  OS_TENANT_NAME: admin
  OS_USERNAME: admin
  OS_PASSWORD: "{{ keystone_pass }}"
  OS_AUTH_URL: "http://{{ services_controller }}:35357/v3"
  OS_AUTH_URL_PUB: "http://{{ services_controller }}:5000"
  OS_IDENTITY_API_VERSION: 3
  OS_IMAGE_API_VERSION: 2

ops_client_env_ssl:
  OS_PROJECT_DOMAIN_NAME: Default
  OS_PROJECT_DOMAIN_ID: default
  OS_USER_DOMAIN_NAME: Default
  OS_USER_DOMAIN_ID: default
  OS_PROJECT_NAME: admin
  OS_TENANT_NAME: admin
  OS_USERNAME: admin
  OS_PASSWORD: "{{ keystone_pass }}"
  OS_AUTH_URL: "https://{{ services_controller }}:35357/v3"
  OS_AUTH_URL_PUB: "https://{{ services_controller }}:5000"
  OS_IDENTITY_API_VERSION: 3
  OS_IMAGE_API_VERSION: 2
  OS_CACERT: "{{ docker_shared_conf_dir }}/openstack-client/openstack.crt"

keystone_env:
  ADMIN_PASS: "{{ keystone_pass }}"
  KEYSTONE_DBPASS: "{{ keystone_dbpass }}"
  TOKEN_EXPIRATION: 7200
  SSL_ENABLED: 1
  SSL_CERT:
    COUNTRY: VN
    STATE: Hanoi
    LOCALITY: Hanoi
    ORGANIZATION: VSC
    COMMON_NAME: "{{ services_controller }}"

glance_env:
  GLANCE_DBPASS: "{{ glance_dbpass }}"
  GLANCE_PASS: "{{ glance_pass }}"
  SSL_ENABLED: 1

nova_env:
  NOVA_DBPASS: "{{ nova_dbpass }}"
  NOVA_PASS: "{{ nova_pass }}"
  PLACEMENT_PASS: "{{ placement_pass }}"
  NEUTRON_PASS: "{{ neutron_pass }}"
  METADATA_PROXY_SHARED_SECRET: "{{ metadata_secret }}"
  SSL_ENABLED: 1

neutron_env:
  NEUTRON_DBPASS: "{{ neutron_dbpass }}"
  NEUTRON_PASS: "{{ neutron_pass }}"
  NOVA_PASS: "{{ nova_pass }}"
  METADATA_PROXY_SHARED_SECRET: "{{ metadata_secret }}"
  SSL_ENABLED: 1

cinder_env:
  CINDER_DBPASS: "{{ cinder_dbpass }}"
  CINDER_PASS: "{{ cinder_pass }}"
  SSL_ENABLED: 1

masakari_env:
  MASAKARI_DBPASS: "{{ masakari_dbpass }}" 
  MASAKARI_PASS: "{{ masakari_pass }}"
  NOVA_PASS: "{{ nova_pass }}"
  MSQ_PASS: "{{ rabbit_passwd }}" 
  OS_CACERT: "{{ docker_shared_conf_dir }}/masakari/ssl/openstack.crt"
  CA_BUNDLE: "{{ docker_shared_conf_dir }}/masakari/ssl/openstack.crt"
  REQUESTS_CA_BUNDLE: "{{ docker_shared_conf_dir }}/masakari/ssl/openstack.crt"
  SSL_ENABLED: 1

heat_env:
  HEAT_DBPASS: "{{ heat_dbpass }}"
  HEAT_PASS: "{{ heat_pass }}"
  HEAT_DOMAIN_PASS: "{{ heat_domain_admin_pass }}"
  SSL_ENABLED: 1

ceilometer_env:
  CEILOMETER_DBPASS: "{{ ceilometer_dbpass }}"
  CEILOMETER_PASS: "{{ ceilometer_pass }}"
  SSL_ENABLED: 1

gnocchi_env:
  GNOCCHI_DBPASS: "{{ gnocchi_dbpass }}"
  GNOCCHI_PASS: "{{ gnocchi_pass }}"
#  GNOCCHI_INDEXER: postgresql
  GNOCCHI_INDEXER: mysql 
#  GNOCCHI_INDEXER_MODE: master_master
  GNOCCHI_INDEXER_MODE: master_slave
  SSL_ENABLED: 1

aodh_env:
  AODH_DBPASS: "{{ aodh_dbpass }}"
  AODH_PASS: "{{ aodh_pass }}"
  SSL_ENABLED: 1

octavia_env:
  OCTAVIA_DBPASS: "{{ octavia_dbpass }}"
  OCTAVIA_PASS: "{{ octavia_pass }}"
  AMP_IMAGE_TAG: amphora
  AMP_BOOT_NETWORK_LIST: 73993b45-2dd4-4c2a-87d1-e80c7c4af400
  SSL_ENABLED: 1

dashboard_env:
  HORIZON_DBPASS: "{{ horizon_dbpass }}"
  SSL_ENABLED: 1

identity_env: "{{ general_env | merge(keystone_env) | merge(no_proxy_env) }}"

openstack_client_env: "{{ general_env | merge(ops_client_env) | merge(glance_env) | merge(nova_env) | merge(neutron_env) | merge(cinder_env) | merge(no_proxy_env) }}"

openstack_client_env_ssl: "{{ general_env | merge(ops_client_env_ssl) | merge(glance_env) | merge(nova_env) | merge(neutron_env) | merge(cinder_env) | merge(no_proxy_env) }}"

image_env: "{{ general_env | merge(glance_env) | merge(no_proxy_env) }}"

compute_env: "{{ general_env | merge(nova_env) | merge(no_proxy_env) }}"

network_env: "{{ general_env | merge(neutron_env) | merge(no_proxy_env) }}"

block_storage_env: "{{ general_env | merge(cinder_env) | merge(no_proxy_env) }}"

horizon_env: "{{ general_env | merge(dashboard_env) | merge(no_proxy_env) }}"

ha_compute_env: "{{ general_env | merge(masakari_env) | merge(no_proxy_env) }}"

orchestration_env: "{{ general_env | merge(heat_env) | merge(no_proxy_env) }}"

data_collection_env: "{{ general_env | merge(ceilometer_env) | merge(no_proxy_env) }}"

metric_storage_env: "{{ general_env | merge(gnocchi_env) | merge(no_proxy_env) }}"

alert_env: "{{ general_env | merge(aodh_env) | merge(no_proxy_env) }}"

loadbalancer_env: "{{ general_env | merge(octavia_env) | merge(no_proxy_env) }}"

grafana:
  fqdn: "http://10.240.206.50:3000"

redis:
  redis_sentinel_port: 26379
  redis_master_set: mymaster
  redis_user:
  redis_password: INCOMING_PASS
  image:
    server: "{{ docker_reg_host }}:{{ docker_host_port }}/redis:latest"
    sentinel: "{{ docker_reg_host }}:{{ docker_host_port }}/redis-sentinel:latest"
  env:
    master:
      REDIS_REPLICATION_MODE: master
      REDIS_PASSWORD: INCOMING_PASS
    slave:
      REDIS_REPLICATION_MODE: slave
      REDIS_MASTER_HOST: "{{ groups['redis-master'][0] }}"
      REDIS_MASTER_PORT_NUMBER: 6379
      REDIS_MASTER_PASSWORD: INCOMING_PASS
      REDIS_PASSWORD: INCOMING_PASS
    sentinel:
      REDIS_MASTER_HOST: "{{ groups['redis-master'][0] }}"
      REDIS_MASTER_SET: mymaster
      REDIS_SENTINEL_QUORUM: 2
      REDIS_MASTER_PORT_NUMBER: 6379
      REDIS_MASTER_PASSWORD: INCOMING_PASS
      REDIS_PASSWORD: INCOMING_PASS
      DOWN_TIMEOUT: 5000
      FAILOVER_TIMEOUT: 10000

zookeeper:
  user: gnocchi
  password: gnocchi
  image: "{{ docker_reg_host }}:{{ docker_host_port }}/zookeeper:latest"
  env:
    ZOO_SERVER_USERS: gnocchi
    ZOO_SERVER_PASSWORDS: ZOO_PASS
    ZOO_SERVER_ID: "{{ zk_server.id }}"
    ZOO_SERVERS: "{{ zk_server.server }}"
    ZOO_ENABLE_AUTH: "yes"
    ZOO_TIMEZONE: Asia/Bangkok
    #ZOO_TIMEZONE: Asia/Saigon
  
postgres_host: "{{ vip.postgres.ip }}"

postgres:
  addr: "{{ postgres_host }}"
  image: "{{ docker_reg_host }}:{{ docker_host_port }}/postdock:latest"
  env:
    master:
      INITIAL_NODE_TYPE: master
      NODE_ID: "{{ postgres_hostvars.NODE_ID }}"
      NODE_NAME: "{{ groups['postgres-master'][0] }}"
      CLUSTER_NODE_NETWORK_NAME: "{{ groups['postgres-master'][0] }}"
      PGPASSWORD: POSTGRES_PWD 
      POSTGRES_PASSWORD: POSTGRES_PWD 
      POSTGRES_USER: postgres_user
      POSTGRES_DB: gnocchi
      CLUSTER_NODE_REGISTER_DELAY: 5
      REPLICATION_DAEMON_START_DELAY: 120
      CLUSTER_NAME: pg_cluster
      REPLICATION_DB: repl_db
      REPLICATION_USER: repl_user
      REPLICATION_PASSWORD: POSTGRES_REPL_PASSWORD
    slave:
      INITIAL_NODE_TYPE: standby
      NODE_ID: "{{ postgres_hostvars.NODE_ID }}"
      NODE_NAME: "{{ inventory_hostname }}"
      CLUSTER_NODE_NETWORK_NAME: "{{ inventory_hostname }}"
      PGPASSWORD: POSTGRES_PWD 
      REPLICATION_PRIMARY_HOST: "{{ groups['postgres-master'][0] }}"
      REPLICATION_DB: repl_db
      REPLICATION_USER: repl_user
      REPLICATION_PASSWORD: POSTGRES_REPL_PASSWORD
      REPLICATION_UPSTREAM_NODE_ID: "{{ hostvars[groups['postgres-master'][0]]['postgres_hostvars']['NODE_ID'] }}" 

postgres_bdr:
  addr: "{{ postgres_host }}"
  image: "{{ docker_reg_host }}:{{ docker_host_port }}/postgres-bdr:latest"
  env:
    POSTGRES_PASSWORD: POSTGRES_PWD 

mysql_host: "{{ vip.mysql.ip }}"

haproxy_env:
  IMAGE: "{{ docker_reg_host }}:{{ docker_host_port }}/haproxy:alpine"
  SHARED_CONF_DIR: "{{ docker_shared_conf_dir }}"
  LOG_PATH: /dev/log
  USER: cloud
  PASS: HAPROXY_PASS 
  MAXCONN: 40000

keepalived_env:
  IMAGE: "{{ docker_reg_host }}:{{ docker_host_port }}/keepalived:alpine"
  KEEPALIVED_AUTOCONF: false
  KEEPALIVED_CONF: /etc/keepalived/keepalived.conf

memcached_env:
  IMAGE: "{{ docker_reg_host }}:{{ docker_host_port }}/memcached:alpine"
  MEMCACHED_USER: memcached
  MEMCACHED_HOST: "{{ ansible_ssh_host }}"
  MEMCACHED_PORT: 11211
  MEMCACHED_MEMUSAGE: 4096 
  MEMCACHED_MAXCONN: 4096 
  MEMCACHED_THREADS: 4
  MEMCACHED_REQUESTS_PER_EVENT: 20

rabbitmq_env:
  IMAGE: "{{ docker_reg_host }}:{{ docker_host_port }}/rabbitmq:3-management"
  RABBITMQ_NODE_IP_ADDRESS: "{{ ansible_ssh_host }}"
  ERL_EPMD_ADDRESS: "{{ ansible_ssh_host }}"
  RABBITMQ_ERLANG_COOKIE: RABBIT_ERL_COOKIE 
  RABBITMQ_VM_MEMORY_HIGH_WATERMARK: 12288m
  RABBITMQ_LOGS: /var/log/rabbitmq/rabbitmq.log
  LOG_DIR: /var/log/rabbitmq/
  MEMORY: 16G
  MONITOR:
    USERNAME: telegraf
    PASSWORD: RABBIT_MONITOR_PASS 

mysql_env:
  openstack:
    IMAGE: "{{ docker_reg_host }}:{{ docker_host_port }}/mariadb-galera:10.2"
    WSREP_CLUSTER_NAME: openstack
    WSREP_NODE_NAME: "{{ inventory_hostname }}"
    WSREP_NODE_ADDRESS: "{{ ansible_ssh_host }}"
    WSREP_CLUSTER_ADDRESS: "gcomm://{{ groups['mysql'] | map('extract', hostvars, ['ansible_ssh_host']) | join(':4567,') }}:4567"
    WSREP_PROVIDER_OPTIONS: "gmcast.listen_addr=tcp://0.0.0.0:4567"
    WSREP_SST_RECEIVE_ADDRESS: "{{ ansible_ssh_host }}:4444"
    MYSQL_HOST: "{{ vip.mysql.ip }}"
    MYSQL_PORT: 3306
    MYSQL_ROOT_PASSWORD: MYSQL_PASS 
    MAX_CONNECTIONS: 10000
    MAX_CONNECT_ERRORS: 10000
    MAX_ALLOWED_PACKET: 16777216
    CONTAINER_NAME: mysql-openstack
    CONTAINER_DATA_DIR: "{{ docker_shared_conf_dir }}/mysql-openstack/"
    CONTAINER_LOG_DIR: /var/log/mysql/openstack
    MONITOR:
      USERNAME: telegraf
      PASSWORD: MYSQL_MONITOR_PASS 
  gnocchi:
    IMAGE: "{{ docker_reg_host }}:{{ docker_host_port }}/mariadb-galera:10.2"
    WSREP_CLUSTER_NAME: gnocchi
    WSREP_NODE_NAME: "{{ inventory_hostname }}"
    WSREP_NODE_ADDRESS: "{{ ansible_ssh_host }}"
    WSREP_CLUSTER_ADDRESS: "gcomm://{{ groups['mysql'] | map('extract', hostvars, ['ansible_ssh_host']) | join(':5678,') }}:5678"
    WSREP_PROVIDER_OPTIONS: "gmcast.listen_addr=tcp://0.0.0.0:5678"
    WSREP_SST_RECEIVE_ADDRESS: "{{ ansible_ssh_host }}:5555"
    MYSQL_HOST: "{{ vip.gnocchi_indexer.ip }}"
    MYSQL_PORT: 3307
    MYSQL_ROOT_PASSWORD: INDEXER_PASS 
    MAX_CONNECTIONS: 10000
    MAX_CONNECT_ERRORS: 10000
    MAX_ALLOWED_PACKET: 16777216
    CONTAINER_NAME: mysql-gnocchi
    CONTAINER_DATA_DIR: "{{ docker_shared_conf_dir }}/mysql-gnocchi/"
    CONTAINER_LOG_DIR: /var/log/mysql/gnocchi
    MONITOR:
      USERNAME: telegraf
      PASSWORD: INDEXER_MONITOR_PASS 
