---

- name: Create shared configuration directory
  file:
    path: "{{ docker_shared_conf_dir }}/nova/"
    state: directory

- name: Create shared configuration directory
  file:
    path: "{{ docker_shared_conf_dir }}/nova/{{ item }}/"
    state: directory
  with_items:
    - backup
    - nova
    - ceph
    - iscsi
    - libvirt
    - default
    - ssl

- name: Config nova-compute (without ceph config)
  template: src=nova.conf.j2 dest="{{ docker_shared_conf_dir }}/nova/nova/nova.conf" backup=yes
  when: (ceph.nova.enabled == 0) and (nova_env.SSL_ENABLED == 0)

- name: Config nova-compute (with ceph config)
  template: src=nova.conf.ceph.j2 dest="{{ docker_shared_conf_dir }}/nova/nova/nova.conf" backup=yes
  when: (ceph.nova.enabled == 1) and (nova_env.SSL_ENABLED == 0)

- name: Config nova-compute (without ceph config)
  template: src=ssl.nova.conf.j2 dest="{{ docker_shared_conf_dir }}/nova/nova/nova.conf" backup=yes
  when: (ceph.nova.enabled == 0) and (nova_env.SSL_ENABLED == 1)

- name: Config nova-compute (with ceph config)
  template: src=ssl.nova.conf.ceph.j2 dest="{{ docker_shared_conf_dir }}/nova/nova/nova.conf" backup=yes
  when: (ceph.nova.enabled == 1) and (nova_env.SSL_ENABLED == 1)

- name: Distribute certs
  copy: src="{{ playbook_dir }}/roles/openstack-client/files/{{ item }}" dest="{{ docker_shared_conf_dir }}/nova/ssl/{{ item }}" backup=yes
  with_items:
    - openstack.crt
    - openstack.key
  when: nova_env.SSL_ENABLED == 1

- name: Config libvirt for migration
  template: src=libvirtd.conf.j2 dest="/etc/libvirt/libvirtd.conf" mode=0644 backup=yes

- name: Config libvirt_opts for migration
  template: src=libvirtd.j2 dest="/etc/default/libvirtd" mode=0644 backup=yes
